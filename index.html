<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../../assets/ico/favicon.ico">

    <title>CivicData.com Test Application - Austin Unclaimed Property Check</title>

    <!-- Bootstrap & Bootswatch CSS -->
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://netdna.bootstrapcdn.com/bootswatch/3.1.1/yeti/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
      body {
        margin-top: 40px;
      }
      table {
        margin-top: 10px;
      }

      .input-group {
        margin-bottom: 10px;
      }
    </style>

  </head>

  <body role="document">

    <!-- Fixed navbar -->
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.html">Unclaimed Property Check</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="index.html">Home</a></li>
            <li><a href="about.html">About</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container theme-flatly" role="main">

      <div class="page-header">
          <h1>Unclaimed Property Check</h1>
          <div class="well">
            <p>This is a sample of an application built using open data hosted at CivicData.com. Every year, various departments of the City of Austin report unclaimed cash and valuables, from uncashed checks, deposits, refunds, overpayments or any other transactions creating a credit balance valued at $100 or less. The source of this data was retreived from <a href="https://www.ci.austin.tx.us/financeonline/finance/financial_docs.cfm?ws=3&pg=1" target="_blank">City of Austin Treasury, Division of Financial & Administrative Services</a>.</p>
          </div>          
      </div>

      <div class="row">
        <div class="col-lg-4">
        <div id="first-name-group" class="input-group">
          <span class="input-group-addon">First Name</span>
          <input type="text" class="form-control" id="inputFirstName">
        </div>
        <div id="last-name-group" class="input-group">
          <span class="input-group-addon">Last Name</span>
          <input type="text" class="form-control" id="inputLastName">
        </div>
        </div>
      </div>
    
      <div>
          <button type="button" value="RunCheck" class="btn btn-lg btn-default">Search Unclaimed Property</button>
          <button type="button" value="" class="btn btn-lg btn-danger">Searching...</button>
      </div>

      <div>
          <div class="col-lg-6" id="results"></div> 
      </div>

      </div> <!-- /container -->


    <!--  Required JavaScript libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <script type="text/javascript">
          $(document).ready(function() {

            $(".btn-danger").hide();

            var resourceId = "efab801d-8815-46af-8961-aec57ab8d83b";
            var baseURI = "http://www.civicdata.com/api/action/datastore_search_sql?sql=";

            // Function to build query based on user input
            function getUnclaimedQuery(lName, fName) {
              var sqlQuery = "select * from \"resource_id\" where upper(\"Last\") like '" + lName.toUpperCase() + "%'";

              if (fName != null && fName != "" && fName != undefined) {
                sqlQuery += " and upper(\"First\") like '%" + fName.toUpperCase + "%'";          
              }

              return baseURI + encodeURIComponent(sqlQuery.replace("resource_id",resourceId));
            }

            // Function to get matching names from dataset
            
            function getUnclaimedMatches(lName, fName) {
              if (lName == null || lName == "" || lName == undefined) {
                $("#last-name-group").attr('class', 'input-group has-error');
                $("#inputLastName").attr('placeholder', 'Last name is required for lookup');
                //$('#results').append('Nothing found');
                return false;
              }

              $.ajax({
                url: getUnclaimedQuery(lName, fName),
                beforeSend: function(xhr) {
                  $(".btn-danger").show();
                },
                complete: function(xhr) {
                  $(".btn-danger").hide();
                  console.log(xhr.responseJSON);
                  var records = xhr.responseJSON.result.records;
                  if (records.length > 0) {
                    $("#results").append("<h4>Click on your name below if found:</h4>");
                    $("#results").append("<table class=\"table table-striped table-bordered table-hover\">");
                    $("#results table").append("<tr><th>First Name</th><th>Last Name</th><th>Middle</th></tr>");
                    for(var i=0; i<records.length; i++) {
                      console.log(records[i]);
                      $("#results table").append("<tr><td><a class=\"details\" href=\"#\">" +  records[i].First + "</a></td><td><a class=\"details\" href=\"#\">" + records[i].Last + "</a></td><td>" + records[i].M + "</td></tr>")
                    }
                    $("#results table").append("</table>");                    
                  } else {
                    $("#results").append("<h2>No records found for name:<br/>" + $('#inputFirstName').val() + " " + $('#inputLastName').val() + "</h2>");
                  }


                }
              });
            }

            function showNextSteps() {

            }

            // Handlers for click events on specific elements.
            $(".btn").click(function() {
              $("#results").empty();
              getUnclaimedMatches($('#inputLastName').val(),$('#inputFirstName').val());
            });

            $("#results").on("click", ".details", function() {
              getSingleRecord($(this).text());
            });

          });
        </script>
  </body>
</html>